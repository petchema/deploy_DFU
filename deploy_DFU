#!/bin/bash
# Deploy Dagggerfall Unity and mods

# Stop if anything goes wrong
set -e

self=$(basename "$0")
version="1.2"

fatal() {
    echo "$self: [FATAL] $1" 1>&2
    exit 1
}

warn() {
    echo "$self: [WARN] $1" 1>&2
}

info() {
    echo "$self: [INFO] $1"
}

usage() {
    echo "Usage: $self [-f <config file>] <target_directory>" 1>&2
    exit 1
}

owndir=$(dirname "$0")
owndir=$(cd "$owndir" && pwd)
[ -z "$owndir" ] && fatal "can't find my own directory"

# Set defaults
SOURCEDIR="$owndir"

configfile=~/".${self}rc"

if [ "$1" = "-f" ]; then
    configfile="$2"
    shift 2
fi
[[ "$1" = "-h" || "$1" = "--help" ]] && usage

[ -n "$1" ] || usage
TARGETDIR="$1"

TEMP=$(mktemp -d)
[ -d "$TEMP" ] || fatal "Couldn't create a private temp directory"
trap "rm -rf $TEMP" EXIT

[ -e "$configfile" ] || fatal "Can't file configuration file \`$configfile'; Please use sample.${self}rc as a template"

source "$configfile"

# -- Archive names

# Base game https://www.dfworkshop.net/projects/daggerfall-unity/live-builds/
case "$BASEGAME" in
    STABLE)
        # Once upon a time, DFU had "stable" branch releases
        # That will come back with 1.0, I guess
        ARC_BASEGAME=interkarma-daggerfall-unity-daggerfallunity_linux_universal-148.zip
        ;;
    ALPHA)
        ARC_BASEGAME=interkarma-daggerfall-unity-daggerfallunity_linux_universal-166.zip
        ;;
    DEV)
        # zip containing everything below "build" subdirectory
        ARC_BASEGAME=daggerfall-unity_linux64-dev.zip
        ;;
    *)
        fatal "BASEGAME should be one of STABLE, ALPHA or DEV"
esac

# Mods https://forums.dfworkshop.net/viewforum.php?f=27

# Daggerfall Remaster 3.0 https://forums.dfworkshop.net/viewtopic.php?f=27&t=1168
ARC_REMASTER30=Textures_3.0.rar

# D.R.E.A.M. https://forums.dfworkshop.net/viewtopic.php?f=27&t=1168
ARC_DREAM='RC5 Linux.rar'

# Daggerfall Textures XL https://forums.dfworkshop.net/viewtopic.php?f=27&t=1176
ARC_TEXTURESXL=Textures.zip

# TOPAZ AI Textures https://forums.dfworkshop.net/viewtopic.php?f=14&t=1642
ARC_TOPAZTEXTURES=TexturesFreak2121.7z

# Trees of Daggerfall https://forums.dfworkshop.net/viewtopic.php?f=22&t=1826
ARC_TREESOFDAGGERFALL="Trees Of Daggerfall BETA 0.9b.zip"

# HD 1st Person Weapon Textures https://forums.dfworkshop.net/viewtopic.php?f=27&t=1612
ARC_HDWEAPONSSWORDS=CifRci_Broadsword.zip
ARC_HDWEAPONSUNARMED=CifRci_Unarmed.zip
ARC_HDWEAPONSWARHAMMER=CifRci_Warhammer.zip
ARC_HDWEAPONSMACE=CifRci_Mace.zip
ARC_HDWEAPONSFLAIL=CifRci_Flail.zip
ARC_HDWEAPONSAXE=CifRci_Axe.zip
ARC_HDWEAPONSDAGGER=CifRci_Dagger.zip

# Bright Exit https://forums.dfworkshop.net/viewtopic.php?f=27&t=1168&start=100#p16197
ARC_BRIGHTEXIT=095_0-0_Emission.png

# Discrete Crosshair https://forums.dfworkshop.net/viewtopic.php?f=27&t=1650
ARC_DISCRETECROSSHAIR=Crosshair.png

# Charcoal Ghosts https://forums.dfworkshop.net/viewtopic.php?f=27&t=1526
ARC_CHARCOALGHOSTS=CharcoalGhosts1.1.zip

# Daggerfont https://forums.dfworkshop.net/viewtopic.php?f=14&t=1538&start=20#p18342
ARC_DAGGERFONT=FONT0003-SDF.zip

# Handpainted Models https://forums.dfworkshop.net/viewtopic.php?f=27&t=583
ARC_HANDPAINTEDMODELS="Handpainted Models v183c - Linux.zip"

# Fancy Indicators https://forums.dfworkshop.net/viewtopic.php?f=22&t=1671
ARC_FANCYINDICATORS=FancyVitalIndicators.zip

# Compass texture https://forums.dfworkshop.net/viewtopic.php?f=14&t=630
ARC_COMPASSTEXTURES=CompassTextures.7z

# Daggerfall World Map https://forums.dfworkshop.net/viewtopic.php?f=22&t=1804
ARC_DAGGERFALLWORLDMAP="Daggerfall World Map.zip"

# Enhanced Sky https://forums.dfworkshop.net/viewtopic.php?f=27&t=1542
ARC_ENHANCEDSKY=EnhancedSky_2.1.1.zip

# Distant Terrain https://forums.dfworkshop.net/viewtopic.php?f=27&t=10
ARC_DISTANTTERRAIN=DistantTerrain_2.6.0.zip

# Mountains and Hills https://forums.dfworkshop.net/viewtopic.php?f=27&t=1008
ARC_MOUNTAINSHILLS="Mountain And Hills 1.02.zip"

# Real Grass 2 https://forums.dfworkshop.net/viewtopic.php?f=27&t=964
ARC_REALGRASS=RealGrass_2.5.1.zip

# Harvestable Crops https://forums.dfworkshop.net/viewtopic.php?f=27&t=964
ARC_HARVESTABLECROPS=HarvestableCrops_0.3.zip

# Vibrant Wind https://forums.dfworkshop.net/viewtopic.php?f=14&t=532
ARC_VIBRANTWIND=VibrantWind_v0.5_.7z

# Birds in Daggerfall II https://forums.dfworkshop.net/viewtopic.php?f=14&t=2214
ARC_BIRDSINDAGGERFALL="BirdsInDaggerfall 2.0.zip"

# Realtime Reflections https://forums.dfworkshop.net/viewtopic.php?f=27&t=122
ARC_REALTIMEREFLECTIONS=RealtimeReflections_2.2.2.zip

# Villager Immersion Overhaul https://forums.dfworkshop.net/viewtopic.php?f=27&t=924
ARC_VILLAGERIMMERSION=VIO-V3.rar

# Post Processing Effects https://forums.dfworkshop.net/viewtopic.php?f=27&t=694
ARC_POSTPROCESSING=PostProcessing_1.0.1.zip

# Improved Interior Lighting https://forums.dfworkshop.net/viewtopic.php?f=27&t=2479
ARC_IMPROVEDLIGHTING="Improved Interior Lighting_1.0.2.rar"

# Convenient Clock https://forums.dfworkshop.net/viewtopic.php?f=27&t=1021
ARC_CONVENIENTCLOCK="Convenient Clock 1.02.zip"

# Loading Screen https://forums.dfworkshop.net/viewtopic.php?f=27&t=469
ARC_LOADINGSCREEN=LoadingScreen_2.2.1.zip
ARC_LOADINGSCREENOBLIVION=OblivionStyledLoadScreensV2.rar

# Readable books https://forums.dfworkshop.net/viewtopic.php?f=14&t=1607
ARC_READABLEBOOKS=books.zip

# Soundscape by MidnightPrince inspired by "Music To Travel By" by Helegad https://forums.dfworkshop.net/viewtopic.php?f=14&t=1347&p=16078#p16078
# Renamed from Sound.zip
ARC_MIDNIGHTPRINCESOUNDSCAPE=Soundscape_MidnightPrince.zip

# Daggerfall Remastered Music Project https://forums.dfworkshop.net/viewtopic.php?f=22&t=921&start=70
ARC_DFREMASTEREDMUSIC=DaggerfallMusicRemasteredFinal.rar

# Vanilla MIDI OST https://forums.dfworkshop.net/viewtopic.php?f=14&t=2341
ARC_VANILLAMIDIOST="Vanilla MIDI OST - Music on a Roland SC55 V2.0-11-2-0-1566768805.7z"

# Cleaned SoundClips https://forums.dfworkshop.net/viewtopic.php?f=14&t=1692
ARC_SOUNDCLIPSMIXDOWN=SoundClips-1.3.zip

# Tedious Travel https://forums.dfworkshop.net/viewtopic.php?f=22&t=1293
ARC_TEDIOUSTRAVEL=TediousTravel-0.4.1.zip

# Warm Ashes: Dangerous Dungeon Exteriors V2.6 https://forums.dfworkshop.net/viewtopic.php?f=27&t=1087
ARC_WARMASHES="WarmAshesV3.0.2.rar"

# Warm Ashes: Wilderness Encounters V3 https://forums.dfworkshop.net/viewtopic.php?f=27&t=1087&start=90#p23111
ARC_WILDERNESSENCOUNTERS=WAQ_Wilderness.rar

# DFU Quest Pack #1 https://forums.dfworkshop.net/viewtopic.php?f=27&t=924
ARC_QUESTPACK1=Quest_Pack_1.zip

# Archeologists guild https://forums.dfworkshop.net/viewtopic.php?f=27&t=888
ARC_ARCHEOLOGISTSGUILD=ArchaeologistsGuild-0.7.zip-14-0-7-1567807547.zip

# Persistent Dungeons https://forums.dfworkshop.net/viewtopic.php?f=27&t=1667
ARC_PERSISTENTDUNGEONS='persistent dungeons.dfmod'

# Daggerfall Autosave https://forums.dfworkshop.net/viewtopic.php?f=14&t=2151
ARC_AUTOSAVE=df-unity.Autosave-Autosave-v0.9.0b.zip

# Drafty Secret Doors https://forums.dfworkshop.net/viewtopic.php?f=14&t=2020
ARC_DRAFTYSECRETDOORS=DraftySecretDoors-1.4.zip

# -- preflight checks

info "Installation preflight checks..."

check_available() {
    command -v "$1" > /dev/null 2>&1 || fatal "\`$1' command not found"
}

# Use 7z for everything?
check_available unzip
check_available unrar
check_available 7z

missing_options=()
for archive in ${!ARC_*}; do
    option="${archive#ARC_}"
    if [ "${!option}" ]; then
        if [ "${!option}" != "N" ]; then
            echo "Testing \`${!archive}' presence..."
            [ -e "$SOURCEDIR/${!archive}" ] || fatal "archive \`$SOURCEDIR/${!archive}' not found, aborting"
        fi
    else
        missing_options+=("$option")
    fi
done
[ ${#missing_options} -gt 0 ] && fatal "Your configuration file is missing options: ${missing_options[*]}"

check_conflicting() {
    local stage=$1
    local reason=$2
    shift 2
    local conflicting=()
    for option in "$@"; do
        [ "${!option}" = "Y" ] && conflicting+=("$option")
    done
    if [ ${#conflicting[*]} -gt 1 ]; then
        case "$stage" in
            INSTALL)
                fatal "You selected conflicting options ($reason): ${conflicting[*]}"
                ;;
            RUNTIME)
                warn "Only enable one of those options at a time ($reason): ${conflicting[*]}"
                ;;
            *)
                fatal "Unknown stage \`$stage'"
                ;;
        esac
    fi
    return 0
}

# Textures
# Not TOPAZTEXTURES here since it's not a full overhaul
check_conflicting INSTALL "Texture overhauls" DREAM REMASTER30 TEXTURESXL

check_conflicting INSTALL "DREAM contains CharcoalGhosts"  DREAM CHARCOALGHOSTS
check_conflicting INSTALL "DREAM contains BrightExit"  DREAM BRIGHTEXIT

# Songs
check_conflicting INSTALL "Songs overhauls" MIDNIGHTPRINCESOUNDSCAPE DFREMASTEREDMUSIC VANILLAMIDIOST
check_conflicting RUNTIME "Songs overhauls" DREAM MIDNIGHTPRINCESOUNDSCAPE DFREMASTEREDMUSIC VANILLAMIDIOST
check_conflicting RUNTIME "Sounds overhauls" SOUNDCLIPSMIXDOWN DREAM

# Terrain generators
check_conflicting RUNTIME "Terrain generators" DISTANTTERRAIN MOUNTAINSHILLS

# Random Encounters
check_conflicting INSTALL "Random encounters" WARMASHES WILDERNESSENCOUNTERS

# -- Let's go

info "Start installation under \`$TARGETDIR'"

SIGNATUREFILE="$TARGETDIR/.deploy_DFU.log"
# Use signature file as an install log
install_log() {
    echo "$1" >> "$SIGNATUREFILE"
}

if [ -d "$TARGETDIR" ]; then
    [ -e "$SIGNATUREFILE" ] || fatal "not replacing \`$TARGETDIR' we didn't create"
    rm -rf "$TARGETDIR"
fi
mkdir -p "$TARGETDIR"
install_log "Install script: $self $version"

unzip "$SOURCEDIR/$ARC_BASEGAME" -d "$TARGETDIR"
install_log "Base game: $ARC_BASEGAME ($BASEGAME)"
install_log "Options: USE_HACKS=$USE_HACKS"
assets="$TARGETDIR"/DaggerfallUnity_Data/StreamingAssets

# -- Eye candy

if [ "$DREAM" = "Y" ]; then
    # Exclude cinematics, VideoPlayer used by Daggerfall Unity does not support
    # MP4s under Linux https://forums.dfworkshop.net/viewtopic.php?f=5&t=1658&p=18923#p18928
    # Also exclude settings for other mods, as bundling settings with mods could be an issue with 0.10.5+
    unrar x -x'Mods/dream - cinematics.dfmod' -x'Mods/*.json' "$SOURCEDIR/$ARC_DREAM" "$assets"/ 'Mods/*' 'SpellIcons/*'
    install_log "Mod: $ARC_DREAM"
fi

if [ "$REMASTER30" = "Y" ]; then
    unrar x "$SOURCEDIR/$ARC_REMASTER30" "$assets"/
    install_log "Mod: $ARC_REMASTER30"
fi

if [ "$TEXTURESXL" = "Y" ]; then
    unzip -o "$SOURCEDIR/$ARC_TEXTURESXL" -d "$assets"/
    install_log "Mod: $ARC_TEXTURESXL"
fi

if [ "$TOPAZTEXTURES" = "Y" ]; then
    7z x "$SOURCEDIR/$ARC_TOPAZTEXTURES" -o"$assets"/ -aoa
    install_log "Mod: $ARC_TOPAZTEXTURES"
fi

if [ "$TREESOFDAGGERFALL" = "Y" ]; then
    unzip -j "$SOURCEDIR/$ARC_TREESOFDAGGERFALL" -d "$assets"/Mods "StandaloneLinux/trees of daggerfall.dfmod"
    install_log "Mod: $ARC_TREESOFDAGGERFALL"
fi

if [ "$HDWEAPONSSWORDS" = "Y" ]; then
    mkdir -p "$assets"/Textures/CifRci
    unzip -o "$SOURCEDIR/$ARC_HDWEAPONSSWORDS" -d "$assets"/Textures/CifRci
    install_log "Mod: $ARC_HDWEAPONSSWORDS"
fi

if [ "$HDWEAPONSUNARMED" = "Y" ]; then
    mkdir -p "$assets"/Textures/CifRci
    unzip -o "$SOURCEDIR/$ARC_HDWEAPONSUNARMED" -d "$assets"/Textures/CifRci
    install_log "Mod: $ARC_HDWEAPONSUNARMED"
fi

if [ "$HDWEAPONSWARHAMMER" = "Y" ]; then
    mkdir -p "$assets"/Textures/CifRci
    unzip -o "$SOURCEDIR/$ARC_HDWEAPONSWARHAMMER" -d "$assets"/Textures/CifRci
    install_log "Mod: $ARC_HDWEAPONSWARHAMMER"
fi

if [ "$HDWEAPONSMACE" = "Y" ]; then
    mkdir -p "$assets"/Textures/CifRci
    unzip -o "$SOURCEDIR/$ARC_HDWEAPONSMACE" -d "$assets"/Textures/CifRci
    install_log "Mod: $ARC_HDWEAPONSMACE"
fi

if [ "$HDWEAPONSFLAIL" = "Y" ]; then
    mkdir -p "$assets"/Textures/CifRci
    unzip -o "$SOURCEDIR/$ARC_HDWEAPONSFLAIL" -d "$assets"/Textures/CifRci
    install_log "Mod: $ARC_HDWEAPONSFLAIL"
fi

if [ "$HDWEAPONSAXE" = "Y" ]; then
    mkdir -p "$assets"/Textures/CifRci
    unzip -o "$SOURCEDIR/$ARC_HDWEAPONSAXE" -d "$assets"/Textures/CifRci
    install_log "Mod: $ARC_HDWEAPONSAXE"
fi

if [ "$HDWEAPONSDAGGER" = "Y" ]; then
    mkdir -p "$assets"/Textures/CifRci
    unzip -o "$SOURCEDIR/$ARC_HDWEAPONSDAGGER" -d "$assets"/Textures/CifRci
    install_log "Mod: $ARC_HDWEAPONSDAGGER"
fi

if [ "$BRIGHTEXIT" = "Y" ]; then
    cp "$SOURCEDIR/$ARC_BRIGHTEXIT" "$assets"/Textures/
    install_log "Mod: $ARC_BRIGHTEXIT"
fi

if [ "$DISCRETECROSSHAIR" = "Y" ]; then
    cp "$SOURCEDIR/$ARC_DISCRETECROSSHAIR" "$assets"/Textures/
    install_log "Mod: $ARC_DISCRETECROSSHAIR"
fi

if [ "$CHARCOALGHOSTS" = "Y" ]; then
    unzip -o "$SOURCEDIR/$ARC_CHARCOALGHOSTS" -d "$assets"/Textures/
    install_log "Mod: $ARC_CHARCOALGHOSTS"
fi

if [ "$DAGGERFONT" = "Y" ]; then
    unzip -o "$SOURCEDIR/$ARC_DAGGERFONT" -d "$assets"/Fonts/
    install_log "Mod: $ARC_DAGGERFONT"
fi

if [ "$HANDPAINTEDMODELS" = "Y" ]; then
    unzip -j "$SOURCEDIR/$ARC_HANDPAINTEDMODELS" -d "$assets"/Mods "StandaloneLinux/*.dfmod"
    install_log "Mod: $ARC_HANDPAINTEDMODELS"
fi

if [ "$FANCYINDICATORS" = "Y" ]; then
    unzip -o "$SOURCEDIR/$ARC_FANCYINDICATORS" -d "$assets"/
    install_log "Mod: $ARC_FANCYINDICATORS"
fi

if [ "$COMPASSTEXTURES" = "Y" ]; then
    7z e "$SOURCEDIR/$ARC_COMPASSTEXTURES" "[MOD] CompassTextures/$COMPASSTEXTURE/*" -o"$assets"/Textures/Img/ -aoa
    # Those compasses have standard size
    for compassfile in "$assets"/Textures/Img/COMP{ASS,BOX}.IMG.xml; do
        [ -e "$compassfile" ] && mv "$compassfile" "$compassfile.disabled"
    done
    install_log "Mod: $ARC_COMPASSTEXTURES ($COMPASSTEXTURE)"
fi

if [ "$DAGGERFALLWORLDMAP" = "Y" ]; then
    unzip -j "$SOURCEDIR/$ARC_DAGGERFALLWORLDMAP" -d "$assets"/Mods "StandaloneLinux/daggerfall world map.dfmod"
    install_log "Mod: $ARC_DAGGERFALLWORLDMAP"
fi

if [ "$ENHANCEDSKY" = "Y" ]; then
    unzip -j "$SOURCEDIR/$ARC_ENHANCEDSKY" -d "$assets"/Mods "StandaloneLinux/enhanced sky.dfmod"
    install_log "Mod: $ARC_ENHANCEDSKY"
fi

if [ "$DISTANTTERRAIN" = "Y" ]; then
    unzip -j "$SOURCEDIR/$ARC_DISTANTTERRAIN" -d "$assets"/Mods "StandaloneLinux/distant terrain.dfmod"
    install_log "Mod: $ARC_DISTANTTERRAIN"
fi

if [ "$MOUNTAINSHILLS" = "Y" ]; then
    unzip -j "$SOURCEDIR/$ARC_MOUNTAINSHILLS" -d "$assets"/Mods "${ARC_MOUNTAINSHILLS%.zip}/mountains and hills.dfmod"
    install_log "Mod: $ARC_MOUNTAINSHILLS"
fi

if [ "$REALGRASS" = "Y" ]; then
    unzip -j "$SOURCEDIR/$ARC_REALGRASS" "${ARC_REALGRASS%.zip}"/Mod/Linux/realgrass.dfmod -d "$assets"/Mods/
    install_log "Mod: $ARC_REALGRASS"
fi

if [ "$HARVESTABLECROPS" = "Y" ]; then
    unzip -j "$SOURCEDIR/$ARC_HARVESTABLECROPS" "${ARC_HARVESTABLECROPS%.zip}"/Linux/harvestablecrops.dfmod -d "$assets"/Mods/
    install_log "Mod: $ARC_HARVESTABLECROPS"
fi

if [ "$VIBRANTWIND" = "Y" ]; then
    7z e "$SOURCEDIR/$ARC_VIBRANTWIND" "${ARC_VIBRANTWIND%.7z}"/Linux/vibrantwind.dfmod -o"$assets"/Mods/
    install_log "Mod: $ARC_VIBRANTWIND"
fi

if [ "$BIRDSINDAGGERFALL" = "Y" ]; then
    unzip -j "$SOURCEDIR/$ARC_BIRDSINDAGGERFALL" "StandaloneLinux/birds in daggerfall.dfmod" -d "$assets"/Mods/
    install_log "Mod: $ARC_BIRDSINDAGGERFALL"
fi

if [ "$REALTIMEREFLECTIONS" = "Y" ]; then
    unzip -j "$SOURCEDIR/$ARC_REALTIMEREFLECTIONS" -d "$assets"/Mods "StandaloneLinux/realtime reflections.dfmod" 
    if [ "$TEXTURESXL" = "Y" ]; then
        echo "TEXTURESXL has REALTIMEREFLECTIONS textures already, skipping"
    else
        unzip "$SOURCEDIR/$ARC_REALTIMEREFLECTIONS" -d "$TEMP" RealtimeReflections_textures.zip
        unzip "$TEMP"/RealtimeReflections_textures.zip -d "$assets"/Textures
    fi
    install_log "Mod: $ARC_REALTIMEREFLECTIONS"
fi

if [ "$VILLAGERIMMERSION" = "Y" ]; then
    unrar e "$SOURCEDIR/$ARC_VILLAGERIMMERSION" "$assets"/Mods/ VIO_V3/ViO_v3_Linux.dfmod
    install_log "Mod: $ARC_VILLAGERIMMERSION"
fi

if [ "$POSTPROCESSING" = "Y" ]; then
    unzip -j "$SOURCEDIR/$ARC_POSTPROCESSING" -d "$assets"/Mods "${ARC_POSTPROCESSING%.zip}"/Linux/postprocessing.dfmod
    install_log "Mod: $ARC_POSTPROCESSING"
fi

if [ "$IMPROVEDLIGHTING" = "Y" ]; then
    unrar e "$SOURCEDIR/$ARC_IMPROVEDLIGHTING" "$assets"/Mods/ "improved interior lighting.dfmod"
    install_log "Mod: $ARC_IMPROVEDLIGHTING"
fi

if [ "$CONVENIENTCLOCK" = "Y" ]; then
    unzip -j "$SOURCEDIR/$ARC_CONVENIENTCLOCK" -d "$assets"/Mods "StandaloneLinux/convenient clock.dfmod"
    # unzip "$SOURCEDIR/$ARC_CONVENIENTCLOCK" -d "$TEMP" "\[OPTIONAL\] TEXTURE OVERRIDE/*"
    # cp -rv "$TEMP/[OPTIONAL] TEXTURE OVERRIDE/StreamingAssets/Textures/Clock" "$assets"/Textures/
    install_log "Mod: $ARC_CONVENIENTCLOCK"
fi

if [ "$LOADINGSCREEN" = "Y" ]; then
    unzip "$SOURCEDIR/$ARC_LOADINGSCREEN" -d "$TEMP" "${ARC_LOADINGSCREEN%.zip}"/StreamingAssets/Mods/LoadingScreen/'*'
    mv -v "$TEMP/${ARC_LOADINGSCREEN%.zip}"/StreamingAssets/Mods/LoadingScreen "$assets"/Mods/
    unzip -j "$SOURCEDIR/$ARC_LOADINGSCREEN" -d "$assets"/Mods/LoadingScreen/ "${ARC_LOADINGSCREEN%.zip}"/OS-specific/Linux/loadingscreen.dfmod
    install_log "Mod: $ARC_LOADINGSCREEN"

    if [ "$LOADINGSCREENOBLIVION" = "Y" ]; then
        unrar x -y "$SOURCEDIR/$ARC_LOADINGSCREENOBLIVION" "$assets"/Mods/LoadingScreen/Images/
        install_log "Mod: $ARC_LOADINGSCREENOBLIVION"
    fi
fi

if [ "$READABLEBOOKS" = "Y" ]; then
    unzip -j "$SOURCEDIR/$ARC_READABLEBOOKS" -d "$assets"/Books/
    install_log "Mod: $ARC_READABLEBOOKS"
fi

# -- Sound

if [ "$MIDNIGHTPRINCESOUNDSCAPE" = "Y" ]; then
    unzip "$SOURCEDIR/$ARC_MIDNIGHTPRINCESOUNDSCAPE" -d "$assets"/
    install_log "Mod: $ARC_MIDNIGHTPRINCESOUNDSCAPE"
fi

if [ "$DFREMASTEREDMUSIC" = "Y" ]; then
    unrar x "$SOURCEDIR/$ARC_DFREMASTEREDMUSIC" "$assets"/Sound/
    install_log "Mod: $ARC_DFREMASTEREDMUSIC"
fi

if [ "$VANILLAMIDIOST" = "Y" ]; then
    7z x "$SOURCEDIR/$ARC_VANILLAMIDIOST" -o"$assets"/
    install_log "Mod: $ARC_VANILLAMIDIOST"
fi


if [ "$SOUNDCLIPSMIXDOWN" = "Y" ]; then
    mkdir -p "$assets"/Sound/
    unzip "$SOURCEDIR/$ARC_SOUNDCLIPSMIXDOWN" -d "$assets"/Sound/
    install_log "Mod: $ARC_SOUNDCLIPSMIXDOWN"
fi

# -- Gameplay

if [ "$TEDIOUSTRAVEL" = "Y" ]; then
    unzip -j "$SOURCEDIR/$ARC_TEDIOUSTRAVEL" -d "$assets"/Mods/ StandaloneLinux/tedioustravel.dfmod
    install_log "Mod: $ARC_TEDIOUSTRAVEL"
fi

if [ "$WARMASHES" = "Y" ]; then
    unrar x "$SOURCEDIR/$ARC_WARMASHES" -d "$assets"/ 'QuestPacks/*'
    install_log "Mod: $ARC_WARMASHES"
fi

if [ "$WILDERNESSENCOUNTERS" = "Y" ]; then
    unrar x "$SOURCEDIR/$ARC_WILDERNESSENCOUNTERS" -d "$assets"/QuestPacks/
    install_log "Mod: $ARC_WILDERNESSENCOUNTERS"
fi

if [ "$QUESTPACK1" = "Y" ]; then
    unzip -o "$SOURCEDIR/$ARC_QUESTPACK1" -d "$assets"/QuestPacks # Should only unpack JH subdir & contents, oh well
    install_log "Mod: $ARC_QUESTPACK1"
fi

if [ "$ARCHEOLOGISTSGUILD" = "Y" ]; then
    unzip -j "$SOURCEDIR/$ARC_ARCHEOLOGISTSGUILD" -d "$assets"/Mods/ archaeologists.dfmod
    install_log "Mod: $ARC_ARCHEOLOGISTSGUILD"
fi

if [ "$PERSISTENTDUNGEONS" = "Y" ]; then
    cp "$SOURCEDIR/$ARC_PERSISTENTDUNGEONS" "$assets"/Mods/
    install_log "Mod: $ARC_PERSISTENTDUNGEONS"
fi

if [ "$AUTOSAVE" = "Y" ]; then
    unzip -j "$SOURCEDIR/$ARC_AUTOSAVE" -d "$assets"/Mods/Autosave "${ARC_AUTOSAVE%.zip}/StandaloneLinux/*"
    install_log "Mod: $ARC_AUTOSAVE"
fi

if [ "$DRAFTYSECRETDOORS" = "Y" ]; then
    unzip -j "$SOURCEDIR//$ARC_DRAFTYSECRETDOORS" -d "$assets"/Mods/ StandaloneLinux/draftysecretdoors.dfmod
    install_log "Mod: $ARC_DRAFTYSECRETDOORS"
fi

if [ "$USE_HACKS" = "Y" ]; then
forcesize () {
    echo "<?xml version=\"1.0\"?>
<info>
<width>$2</width>
<height>$3</height>
</info>" > "$assets/Textures/$1.xml"
}

    # https://forums.dfworkshop.net/viewtopic.php?f=27&t=1021&p=14696#p14696
    if [ "$CONVENIENTCLOCK" = "Y" ]; then
        # Not compatible with resized compasses, revert to original size
        forcesize Img/COMPASS.IMG 322 14
        forcesize Img/COMPBOX.IMG 69 17
    fi
fi

install_log "Installation: successful"
info "Installed successfully under \`$TARGETDIR'"
exit 0
